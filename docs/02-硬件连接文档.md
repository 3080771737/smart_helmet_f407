# STM32智能安全帽 - 硬件连接文档

> **目标**: 提供清晰的硬件连接指南，确保每个模块正确连接，避免硬件损坏
> **适用板子**: STM32F407VET6开发板 + 各传感器模块

---

## 📌 安全警告

⚠️ **在连接硬件前，请务必阅读以下注意事项：**

1. **断电操作**: 所有接线必须在**断电状态**下进行
2. **电压匹配**: 确认模块工作电压（3.3V或5V），接错会烧毁模块
3. **共地原则**: 所有模块必须与STM32**共地**（GND连在一起）
4. **防短路**: 检查接线无误后再上电，避免VCC与GND短路
5. **静电防护**: 触摸模块前先释放静电（摸一下金属外壳）

---

## 🔌 供电系统设计

### 供电拓扑图
```
┌─────────────┐
│ 5V锂电池组  │ (2000mAh+)
│ (18650x2串) │
└──────┬──────┘
       │
       ├──────────────┐
       │              │
   ┌───▼────┐    ┌────▼─────┐
   │STM32   │    │AMS1117   │
   │5V引脚  │    │3.3V稳压  │
   └───┬────┘    └────┬─────┘
       │              │
       ├──────┬───────┼──────┬───────┐
       │      │       │      │       │
    ┌──▼─┐ ┌─▼──┐ ┌──▼─┐ ┌──▼──┐ ┌──▼──┐
    │MQ2 │ │GPS │ │AHT │ │ICM  │ │MAX  │
    │5V  │ │5V  │ │3.3V│ │3.3V │ │5V   │
    └────┘ └────┘ └────┘ └─────┘ └─────┘
```

### 电流预算表

| 模块 | 工作电压 | 工作电流 | 峰值电流 | 备注 |
|-----|---------|---------|---------|------|
| STM32F407VET6 | 3.3V | 50mA | 100mA | 核心MCU |
| AHT20 | 3.3V | 0.5mA | 1mA | 板载传感器 |
| ICM-20608-G | 3.3V | 3.2mA | 4mA | 板载传感器 |
| MQ2 | 5V | 150mA | 160mA | **需外部5V！** |
| MAX30102 | 5V | 7mA | 50mA | 工作时电流波动大 |
| ATGM336H | 5V | 25mA | 45mA | 定位时功耗高 |
| ESP01S | 3.3V | 70mA | 300mA | **峰值电流极大！** |
| ASR-PRO | 5V | 100mA | 200mA | 播报时功耗高 |
| **总计** | - | **~400mA** | **~860mA** | 建议2A电源 |

**供电建议**:
- ✅ 使用2节18650串联（7.4V）+ DC-DC降压到5V
- ✅ 使用5V 2A移动电源
- ❌ **不要**用STM32的3.3V/5V引脚给ESP01S供电（会导致复位）

---

## 📍 STM32F407VET6引脚分配总表

### 已使用引脚清单

| 引脚 | 功能 | 连接模块 | 信号类型 | 电压 | 说明 |
|-----|------|---------|---------|------|------|
| **电源** |
| 5V | 电源输入 | 锂电池+ | 电源 | 5V | 主供电 |
| 3.3V | 电源输出 | 部分模块VCC | 电源 | 3.3V | 最大150mA |
| GND | 地 | 所有模块GND | 地 | 0V | **必须共地** |
| **GPIO** |
| PA0 | ADC1_IN0 | MQ2 AO | 模拟输入 | 0-3.3V | 烟雾浓度 |
| PA8 | GPIO_Output | (预留DHT11) | 双向IO | 5V容 | 可选 |
| PB13 | GPIO_Input | MAX30102 INT | 中断输入 | 3.3V | 数据就绪 |
| PB14 | GPIO_Output | MAX30102 SDA | I2C数据 | 3.3V | 软件I2C |
| PB15 | GPIO_Output | MAX30102 SCL | I2C时钟 | 3.3V | 软件I2C |
| **I2C1（硬件）** |
| PB6 | I2C1_SCL | 板载传感器SCL | I2C时钟 | 3.3V | AHT20+ICM20608 |
| PB7 | I2C1_SDA | 板载传感器SDA | I2C数据 | 3.3V | 共享总线 |
| **USART1** |
| PA9 | USART1_TX | ASR-PRO PA3 | 串口发送 | 3.3V | 语音模块 |
| PA10 | USART1_RX | ASR-PRO PA2 | 串口接收 | 3.3V | 115200bps |
| **USART2** |
| PA2 | USART2_TX | ATGM336H RX | 串口发送 | 3.3V | GPS模块 |
| PA3 | USART2_RX | ATGM336H TX | 串口接收 | 3.3V | 9600bps |
| **USART3** |
| PB10 | USART3_TX | ESP01S RX | 串口发送 | 3.3V | WiFi模块 |
| PB11 | USART3_RX | ESP01S TX | 串口接收 | 3.3V | 115200bps |
| **调试接口** |
| PA13 | SWDIO | DAP-Link SWDIO | 调试数据 | 3.3V | SWD调试 |
| PA14 | SWCLK | DAP-Link SWCLK | 调试时钟 | 3.3V | SWD调试 |

### 未使用但推荐扩展的引脚

| 引脚 | 可用功能 | 推荐用途 | 说明 |
|-----|---------|---------|------|
| PA1 | ADC1_IN1 | 电池电压检测 | 通过分压电阻检测电量 |
| PA4 | GPIO/DAC1 | 蜂鸣器PWM | 报警音效 |
| PA5 | SPI1_SCK | OLED CLK | 0.96寸显示屏 |
| PA6 | SPI1_MISO | OLED MISO | SPI通信 |
| PA7 | SPI1_MOSI | OLED MOSI | SPI通信 |
| PB0 | GPIO | 按键输入 | 功能按钮 |
| PB1 | GPIO | 按键输入 | 复位按钮 |
| PC13 | GPIO_Output | 板载LED | 调试指示灯 |
| PC14 | GPIO | 外接LED | 状态指示 |
| PC15 | GPIO | 继电器控制 | 外设开关 |

---

## 🔧 各模块详细连接

### 1. 调试器连接（DAP-Link / ST-Link）

#### 接线图
```
┌─────────────┐              ┌─────────────────┐
│  DAP-Link   │              │  STM32F407VET6  │
├─────────────┤              ├─────────────────┤
│ 3V3  (红)   │─────────────→│ 3.3V            │ (仅检测，不供电)
│ SWCLK(黄)   │─────────────→│ PA14 (SWCLK)    │
│ SWDIO(绿)   │─────────────→│ PA13 (SWDIO)    │
│ GND  (黑)   │─────────────→│ GND             │
└─────────────┘              └─────────────────┘
```

#### 连接步骤
1. **断开所有电源**（USB、电池）
2. 按颜色对应连接4根线
3. 先给STM32上电（插电池或USB）
4. 再插DAP-Link到电脑USB口
5. 打开Keil，点击"Download"应显示连接成功

#### 注意事项
- ⚠️ 3V3引脚**仅用于电压检测**，不要用它给STM32供电
- ⚠️ 如果"Download"失败，检查BOOT0跳线是否接GND
- ⚠️ 烧录时不要同时连接串口调试工具

---

### 2. 板载传感器（AHT20 + ICM-20608-G）

#### 硬件说明

这两个传感器已经**焊接在STM32F407VET6开发板上**，共享I2C1总线，无需额外接线！

#### I2C总线拓扑
```
STM32F407VET6
    │
    ├─ PB6 (I2C1_SCL) ───┬─── AHT20 (0x70)
    │                    │
    └─ PB7 (I2C1_SDA) ───┴─── ICM-20608-G (0xD0)
```

#### 电气参数
| 传感器 | I2C地址 | 工作电压 | 上拉电阻 | 通信速度 |
|-------|--------|---------|---------|---------|
| AHT20 | 0x70 (写地址) | 3.3V | 板载4.7kΩ | 400kHz |
| ICM-20608-G | 0xD0 (AD0=GND) | 3.3V | 板载4.7kΩ | 400kHz |

#### CubeMX配置要点
```
I2C1 Mode: I2C
I2C Speed: Fast Mode (400kHz)
Clock Speed: 400000 Hz
Rise Time: 300ns
Fall Time: 100ns
```

#### 测试代码
```c
// 测试I2C总线是否正常
HAL_StatusTypeDef status;
uint8_t data;

// 测试AHT20
status = HAL_I2C_Mem_Read(&hi2c1, 0x70, 0x71, 1, &data, 1, 1000);
if(status == HAL_OK) {
    printf("AHT20: OK\r\n");
} else {
    printf("AHT20: FAIL\r\n");
}

// 测试ICM20608
status = HAL_I2C_Mem_Read(&hi2c1, 0xD0, 0x75, 1, &data, 1, 1000);
if(status == HAL_OK && data == 0xAF) {
    printf("ICM20608: OK (WHO_AM_I=0x%02X)\r\n", data);
} else {
    printf("ICM20608: FAIL\r\n");
}
```

---

### 3. MQ2烟雾传感器

#### 接线图
```
┌─────────────┐              ┌─────────────────┐
│     MQ2     │              │  STM32F407VET6  │
├─────────────┤              ├─────────────────┤
│ VCC (红)    │─────┐        │                 │
│             │     │        │                 │
│ GND (黑)    │─────┼───────→│ GND             │
│             │     │        │                 │
│ AO  (黄)    │─────┼───────→│ PA0 (ADC1_IN0)  │
│             │     │        │                 │
│ DO  (绿)    │     │        │ (不接)          │
└─────────────┘     │        └─────────────────┘
                    │
               ┌────▼────┐
               │ 外部5V  │ ⚠️ 必须外部供电！
               │ 稳压源  │
               └─────────┘
```

#### 供电方案选择

**方案A: 使用ASR-PRO语音模块的5V引脚**
```
ASR-PRO 5V ──→ MQ2 VCC
ASR-PRO GND ──→ MQ2 GND (同时接STM32 GND)
```
- ✅ 优点: 简单，不需要额外模块
- ⚠️ 注意: ASR-PRO必须插电供电（USB或外接5V）

**方案B: 使用LM2596降压模块**
```
电池7.4V ──→ LM2596 IN
LM2596 OUT (调到5V) ──→ MQ2 VCC
LM2596 GND ──→ MQ2 GND (同时接STM32 GND)
```
- ✅ 优点: 供电稳定，电流充足
- ❌ 缺点: 需要额外购买降压模块

**方案C: 使用移动电源**
```
移动电源5V输出 ──→ MQ2 VCC
移动电源GND ──→ MQ2 GND (同时接STM32 GND)
```
- ✅ 优点: 最稳定，电流最大
- ❌ 缺点: 便携性差

#### 电气参数
| 参数 | 数值 | 说明 |
|-----|------|------|
| 工作电压 | 5V ±0.1V | **必须5V，不能3.3V** |
| 加热电流 | 150mA | 持续功耗 |
| 负载电阻 | 4.7kΩ | 模块已集成 |
| 输出电压 | 0-5V | STM32只能测0-3.3V |
| 预热时间 | 1-2分钟 | 刚上电数据不准 |

#### 保护电路（可选）
为防止AO输出>3.3V烧坏PA0，可增加保护电路：
```
MQ2 AO ──[1kΩ电阻]──┬──→ PA0
                    │
                   [3.3V稳压二极管]
                    │
                   GND
```

#### CubeMX配置
```
ADC1 Configuration:
- Channel: IN0 (PA0)
- Resolution: 12 bit
- Sampling Time: 480 Cycles
- Continuous Conversion: Enable
- DMA: Enable, Circular Mode
```

#### 常见问题
**Q: MQ2数据一直是4095？**
A: 检查AO引脚是否悬空，确认模块已供电

**Q: MQ2数据跳变剧烈？**
A: 等待预热1-2分钟，使用DMA多次采样求平均值

**Q: STM32的5V引脚能给MQ2供电吗？**
A: **不能！** 实测STM32的5V引脚只有4.7V，且电流不足

---

### 4. MAX30102心率血氧传感器

#### 接线图
```
┌─────────────┐              ┌─────────────────┐
│  MAX30102   │              │  STM32F407VET6  │
├─────────────┤              ├─────────────────┤
│ VCC (红)    │─────────────→│ 5V              │
│ GND (黑)    │─────────────→│ GND             │
│ SCL (黄)    │─────────────→│ PB15 (GPIO)     │ 软件I2C
│ SDA (绿)    │─────────────→│ PB14 (GPIO)     │ 软件I2C
│ INT (蓝)    │─────────────→│ PB13 (GPIO_IN)  │ 中断
└─────────────┘              └─────────────────┘
```

#### 为什么用软件I2C？
- 硬件I2C1已被板载传感器占用（AHT20+ICM20608）
- I2C2可能与其他扩展冲突
- 软件I2C更灵活，任意GPIO可用

#### 上拉电阻配置
MAX30102模块通常**已板载4.7kΩ上拉电阻**，无需外接。

如果你的模块**没有上拉电阻**，需要在SCL和SDA分别接4.7kΩ上拉到3.3V：
```
3.3V ──[4.7kΩ]──┬─→ SCL (PB15)
                │
3.3V ──[4.7kΩ]──┴─→ SDA (PB14)
```

#### 电气参数
| 参数 | 数值 | 说明 |
|-----|------|------|
| 工作电压 | 3.3V-5V | 推荐5V，亮度更高 |
| 工作电流 | 7mA (静态) | LED开启时>50mA |
| I2C地址 | 0xAE (写) | 0xAF (读) |
| I2C速度 | 最高400kHz | 软件I2C建议100kHz |
| 采样率 | 50-400Hz | 本项目用100Hz |

#### CubeMX配置
```
PB14: GPIO_Output (SDA)
  - Mode: Output Push Pull
  - Pull-up: No pull-up and pull-down
  - Speed: Very High
  - Initial State: High

PB15: GPIO_Output (SCL)
  - 同上

PB13: GPIO_Input (INT)
  - Mode: Input
  - Pull-up: Pull-up
  - External Interrupt: Disable (软件查询)
```

#### 测试手指接触
MAX30102对手指接触**非常敏感**：
- ✅ 手指紧贴传感器，覆盖红光和红外LED
- ❌ 不要按太紧（会阻断血液流动）
- ❌ 不要戴手套
- ❌ 指甲油会影响测量

#### 调试技巧
```c
// 检测手指是否放好
uint32_t red_value = MAX30102_Read_Red();
if(red_value > 100000) {
    printf("手指接触良好\r\n");
} else {
    printf("请将手指紧贴传感器\r\n");
}
```

---

### 5. ATGM336H GPS模块

#### 接线图
```
┌─────────────┐              ┌─────────────────┐
│  ATGM336H   │              │  STM32F407VET6  │
├─────────────┤              ├─────────────────┤
│ VCC (红)    │─────────────→│ 5V              │
│ GND (黑)    │─────────────→│ GND             │
│ TX  (黄)    │─────────────→│ PA3 (USART2_RX) │
│ RX  (绿)    │─────────────→│ PA2 (USART2_TX) │
│ PPS (蓝)    │              │ (不接)          │
└─────────────┘              └─────────────────┘
```

#### 注意TX/RX交叉连接
- GPS的TX → STM32的RX（PA3）
- GPS的RX → STM32的TX（PA2）
- 很多人接反导致无数据！

#### 电气参数
| 参数 | 数值 | 说明 |
|-----|------|------|
| 工作电压 | 3.3V-5V | 推荐5V |
| 工作电流 | 25mA (搜星) | 45mA (定位) |
| 波特率 | **9600** | 出厂默认 |
| 数据格式 | 8N1 | 8位数据，无校验，1位停止 |
| 更新频率 | 1Hz (1秒1次) | 可配置到10Hz |

#### 天线安装
ATGM336H内置陶瓷天线，**天线面必须朝上**，且：
- ✅ 放在室外空旷处
- ✅ 天线上方无遮挡
- ❌ 不要放在室内（混凝土屏蔽信号）
- ❌ 不要靠近金属物体

#### 冷启动与热启动
| 类型 | 定位时间 | 条件 |
|-----|---------|------|
| 冷启动 | 1-3分钟 | 首次开机或长时间断电 |
| 温启动 | 30-60秒 | 短时间断电（<4小时） |
| 热启动 | <10秒 | 刚断电重启 |

#### CubeMX配置
```
USART2 Configuration:
- Mode: Asynchronous
- Baud Rate: 9600 Bits/s
- Word Length: 8 Bits
- Parity: None
- Stop Bits: 1
- Global Interrupt: Enable
```

#### 定位指示灯
ATGM336H模块上通常有一个LED指示灯：
- **慢闪（1Hz）**: 未定位，正在搜星
- **快闪（5Hz）**: 已定位成功

#### 调试技巧
```c
// 打印原始NMEA数据
void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart) {
    if(huart->Instance == USART2) {
        printf("%c", rx_byte);  // 直接打印，查看格式
        HAL_UART_Receive_IT(&huart2, &rx_byte, 1);
    }
}
```

---

### 6. ESP01S WiFi模块

#### 接线图
```
┌─────────────┐              ┌─────────────────┐
│   ESP01S    │              │  STM32F407VET6  │
├─────────────┤              ├─────────────────┤
│ VCC (红)    │──┐           │                 │
│ GND (黑)    │──┼──────────→│ GND             │
│ TX  (黄)    │  │          →│ PB11 (USART3_RX)│
│ RX  (绿)    │  │          →│ PB10 (USART3_TX)│
│ CH_PD(蓝)   │──┘           │                 │
│ GPIO0(白)   │              │ (悬空或接高)     │
│ GPIO2(紫)   │              │ (悬空或接高)     │
│ RST  (灰)   │              │ (悬空或接高)     │
└─────────────┘  │           └─────────────────┘
                 │
            ┌────▼────┐
            │ AMS1117 │ ⚠️ 必须外部3.3V稳压！
            │ 3.3V    │    电流要求>500mA
            │ 稳压模块 │
            └─────────┘
```

#### ESP01S引脚功能详解
| 引脚 | 名称 | 功能 | 连接方式 |
|-----|------|------|---------|
| 1 | GND | 地 | GND |
| 2 | TX | 串口发送 | → STM32 RX (PB11) |
| 3 | GPIO2 | 通用IO | 悬空或接VCC（上拉） |
| 4 | CH_PD | 芯片使能 | **必须接VCC** |
| 5 | GPIO0 | 通用IO/下载模式 | 悬空或接VCC（上拉） |
| 6 | RST | 复位 | 悬空或接VCC（上拉） |
| 7 | RX | 串口接收 | ← STM32 TX (PB10) |
| 8 | VCC | 电源 | **外部3.3V，>500mA** |

#### 供电方案（关键！）

**❌ 错误方案: 直接用STM32的3.3V**
```
STM32 3.3V ──X──→ ESP01S VCC  // 会导致ESP01S反复重启！
```
STM32的3.3V引脚最大输出150mA，而ESP01S峰值电流达300mA，供电不足！

**✅ 正确方案A: AMS1117稳压模块**
```
电池5V ──→ AMS1117 IN
AMS1117 OUT ──→ ESP01S VCC
AMS1117 GND ──→ ESP01S GND + STM32 GND
```
- AMS1117-3.3输出电流可达1A
- 淘宝价格约1-2元/个

**✅ 正确方案B: 移动电源**
```
移动电源5V ──→ AMS1117 IN
(或直接用3.3V输出的移动电源)
```

#### 电气参数
| 参数 | 数值 | 说明 |
|-----|------|------|
| 工作电压 | 3.3V | **严禁接5V！** |
| 静态电流 | 70mA | 空闲待机 |
| 峰值电流 | **300mA** | WiFi传输时 |
| 波特率 | 115200 | 出厂默认 |
| WiFi协议 | 802.11 b/g/n | 2.4GHz |

#### CH_PD引脚必须拉高
CH_PD是芯片使能引脚，**必须接VCC**，否则ESP01S不工作！

有些模块已板载上拉电阻，可以直接用。如果模块没有，需要外接：
```
VCC ──[10kΩ]── CH_PD
```

#### 烧录AT固件（如果模块是空片）
1. 购买ESP01S专用烧录器
2. 下载最新AT固件（安信可官网）
3. 使用Flash Download Tool烧录
4. 烧录完成后，串口发送`AT\r\n`应返回`OK`

#### CubeMX配置
```
USART3 Configuration:
- Mode: Asynchronous
- Baud Rate: 115200 Bits/s
- Word Length: 8 Bits
- Parity: None
- Stop Bits: 1
```

#### 调试技巧
```c
// 测试ESP01S是否正常
my_printf(&huart3, "AT\r\n");
HAL_Delay(100);
// 应收到: OK

// 查询固件版本
my_printf(&huart3, "AT+GMR\r\n");
HAL_Delay(100);
// 应收到: AT version:... SDK version:...
```

---

### 7. 天问ASR-PRO语音模块

#### 接线图
```
┌─────────────┐              ┌─────────────────┐
│  ASR-PRO    │              │  STM32F407VET6  │
├─────────────┤              ├─────────────────┤
│ VCC (红)    │─────────────→│ 5V              │
│ GND (黑)    │─────────────→│ GND             │
│ PA2 (黄)    │─────────────→│ PA10 (USART1_RX)│ ASR→STM32
│ PA3 (绿)    │─────────────→│ PA9  (USART1_TX)│ STM32→ASR
│ PA5 (蓝)    │──┐           │                 │ 继电器2
│ PA6 (紫)    │──┼───────────→│ (外接继电器)     │ 继电器1
│ 5V  (橙)    │  │           │                 │ 输出5V
│ 3.3V(白)    │  │           │                 │ 输出3.3V
└─────────────┘  │           └─────────────────┘
                 │
            ┌────▼────────┐
            │ 双路继电器   │
            │ IN1 ← PA6   │
            │ IN2 ← PA5   │
            │ VCC ← 5V    │
            │ GND ← GND   │
            └─────────────┘
```

#### ASR-PRO引脚功能
| 引脚 | 功能 | 说明 |
|-----|------|------|
| VCC | 电源输入 | 5V，可接USB或外部电源 |
| GND | 地 | 共地 |
| PA2 | UART TX | 发送识别结果到STM32 |
| PA3 | UART RX | 接收STM32的播报指令 |
| PA5 | GPIO | 可配置为继电器控制（风扇） |
| PA6 | GPIO | 可配置为继电器控制（电灯） |
| 5V  | 电源输出 | 可给外设供电（最大500mA） |
| 3.3V| 电源输出 | 可给外设供电（最大150mA） |

#### 电气参数
| 参数 | 数值 | 说明 |
|-----|------|------|
| 工作电压 | 5V | 推荐USB供电 |
| 工作电流 | 100mA (静音) | 200mA (播报) |
| 波特率 | 115200 | 可配置 |
| 识别距离 | 0.5-3米 | 环境安静时 |
| 识别时间 | <500ms | 离线识别 |

#### 继电器连接（可选）
如果需要语音控制LED和风扇：
```
双路继电器模块:
  VCC ← ASR-PRO 5V
  GND ← GND
  IN1 ← ASR-PRO PA6 (控制LED)
  IN2 ← ASR-PRO PA5 (控制风扇)

  COM1 ← 5V
  NO1  → LED VCC

  COM2 ← 5V
  NO2  → 风扇VCC
```

#### 语音配置流程
1. 下载"天问语音工程师"软件
2. 使用USB线连接ASR-PRO到电脑
3. 打开软件，新建工程
4. 添加词条（见开发流程文档）
5. 烧录到模块

#### CubeMX配置
```
USART1 Configuration:
- Mode: Asynchronous
- Baud Rate: 115200 Bits/s
- Word Length: 8 Bits
- Parity: None
- Stop Bits: 1
- Global Interrupt: Enable
```

---

## 🔍 接线检查清单

### 上电前检查（必做！）

- [ ] **所有VCC连接正确**（3.3V的接3.3V，5V的接5V）
- [ ] **所有GND已共地**（用万用表测量连通性）
- [ ] **TX/RX没有接反**（GPS、ESP01S、ASR-PRO）
- [ ] **没有短路**（VCC与GND之间电阻>1kΩ）
- [ ] **ESP01S已外部3.3V供电**（不是STM32的3.3V）
- [ ] **MQ2已外部5V供电**（不是STM32的5V）
- [ ] **CH_PD已接VCC**（ESP01S的使能引脚）
- [ ] **DAP-Link未连接**（先测试硬件，再烧录程序）

### 上电后检查

- [ ] **STM32板载LED亮**（PC13或电源指示灯）
- [ ] **各模块指示灯亮**（如果有）
- [ ] **用手摸芯片不烫**（如果烫手说明短路）
- [ ] **测量关键引脚电压**（3.3V引脚应为3.2-3.4V，5V引脚应为4.8-5.2V）

### 烧录后检查

- [ ] **串口能打印调试信息**（波特率115200）
- [ ] **板载传感器能读取数据**（AHT20、ICM20608）
- [ ] **GPS能收到NMEA数据**（室外测试）
- [ ] **ESP01S能连接WiFi**（AT指令测试）
- [ ] **语音模块能识别词条**（说"打开电灯"）

---

## 🛠️ 常见接线问题排查

### 问题1: 上电后STM32无反应

**可能原因**:
1. 电源未接或接触不良
2. BOOT0跳线错误（应接GND）
3. 电源短路导致保护

**排查步骤**:
```
1. 用万用表测量5V和3.3V引脚电压
2. 检查BOOT0跳线位置
3. 断开所有外设，只给STM32供电
4. 如果板载LED不亮，可能是板子损坏
```

### 问题2: ESP01S反复重启

**现象**: 串口不断输出乱码，或打印"ets Jan  8 2013..."

**原因**: 供电不足！

**解决方案**:
```
1. 检查是否用了STM32的3.3V供电（错误！）
2. 换用AMS1117稳压模块或移动电源
3. 用示波器查看ESP01S的VCC引脚，波动应<100mV
```

### 问题3: GPS无数据

**可能原因**:
1. TX/RX接反了
2. 波特率不对（应为9600）
3. 室内无法定位

**排查步骤**:
```
1. 交换TX和RX连接试试
2. 用串口助手直连GPS模块，查看原始数据
3. 把GPS拿到室外空旷处，等待3分钟
4. 检查GPS模块的LED指示灯（应该在闪烁）
```

### 问题4: I2C传感器无响应

**可能原因**:
1. SDA/SCL接反
2. I2C地址错误
3. 上拉电阻缺失

**排查步骤**:
```c
// 扫描I2C总线上的设备
for(uint8_t addr = 0; addr < 128; addr++) {
    if(HAL_I2C_IsDeviceReady(&hi2c1, addr<<1, 1, 10) == HAL_OK) {
        printf("Found device at 0x%02X\r\n", addr);
    }
}
// 应该找到0x38(AHT20)和0x68(ICM20608)
```

### 问题5: MQ2数据一直是4095

**可能原因**:
1. AO引脚悬空（未接PA0）
2. MQ2未供电
3. ADC未初始化

**排查步骤**:
```
1. 用万用表测量MQ2的VCC引脚（应为5V）
2. 测量MQ2的AO引脚电压（应在0.5-2.5V之间）
3. 检查PA0引脚配置（应为ADC_IN0）
```

---

## 📸 推荐的布线方式

### 面包板布局建议
```
┌────────────────────────────────────────┐
│  MQ2   │  MAX30102  │  GPS  │  ESP01S  │
├────────────────────────────────────────┤
│                                        │
│        STM32F407VET6开发板             │
│                                        │
├────────────────────────────────────────┤
│  AMS1117  │  ASR-PRO  │  继电器        │
└────────────────────────────────────────┘
```

### 走线注意事项
1. **电源线用粗线**（最好用2根杜邦线并联）
2. **地线集中到一点**（星形接地，避免地环路）
3. **信号线远离电源线**（避免干扰）
4. **I2C和UART线不要太长**（<20cm为佳）

---

## 📋 最终接线自检表

| 检查项 | 状态 | 备注 |
|-------|-----|------|
| STM32供电正常 | ☐ | 5V或USB供电 |
| 所有模块共地 | ☐ | 用万用表验证 |
| 板载传感器自检通过 | ☐ | I2C扫描找到0x38和0x68 |
| MQ2外部5V供电 | ☐ | 不用STM32的5V |
| MAX30102软件I2C正常 | ☐ | 读取器件ID=0x15 |
| GPS串口有数据 | ☐ | 室外能看到$GN开头的语句 |
| ESP01S外部3.3V供电 | ☐ | 不用STM32的3.3V |
| ESP01S能响应AT指令 | ☐ | 发送AT返回OK |
| ASR-PRO能识别词条 | ☐ | 说"打开电灯"有反应 |
| 串口调试输出正常 | ☐ | 115200波特率 |

---

**完成以上所有接线后，就可以开始软件开发了！** 🎉

如有任何硬件问题，请参考"常见问题排查"章节，或使用万用表、逻辑分析仪进行调试。
