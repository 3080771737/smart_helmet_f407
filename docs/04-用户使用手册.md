# STM32智能安全帽 - 用户使用手册

> **版本**: v1.0 (基于STM32F407VET6)
> **目标用户**: 电子工程、嵌入式系统、物联网专业学生
> **适用场景**: 课程设计、毕业设计、创新项目

---

## 📋 目录

- [第一部分: 项目简介](#第一部分项目简介)
- [第二部分: 采购清单](#第二部分采购清单)
- [第三部分: 快速上手](#第三部分快速上手)
- [第四部分: 功能使用](#第四部分功能使用)
- [第五部分: 故障排查](#第五部分故障排查)
- [第六部分: 常见问题](#第六部分常见问题)

---

## 第一部分：项目简介

### 1.1 项目概述

**STM32智能安全帽监测系统**是一款基于STM32F407VET6微控制器的物联网监测设备，专为工地、矿井等危险作业环境设计。

**核心功能**：
1. **环境监测**: 实时检测温度、湿度、烟雾浓度
2. **健康监测**: 测量心率、血氧饱和度
3. **姿态监测**: 检测摔倒、碰撞等危险动作
4. **定位追踪**: GPS实时定位记录作业轨迹
5. **语音交互**: 离线语音识别与播报
6. **数据上云**: WiFi无线上传数据到华为云IoT平台

### 1.2 技术参数

| 参数 | 规格 |
|-----|------|
| 主控芯片 | STM32F407VET6 (168MHz, 512KB Flash, 128KB RAM) |
| 供电方式 | 5V锂电池组或USB供电 |
| 工作温度 | -10°C ~ 60°C |
| 续航时间 | 约2-3小时（满载）|
| 通信方式 | WiFi (ESP01S)、UART、I2C |
| 尺寸 | 约10cm × 10cm × 5cm（主控板+传感器） |
| 重量 | 约200g（不含安全帽） |

### 1.3 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                  STM32F407VET6 (168MHz)                  │
├──────────┬──────────┬──────────┬──────────┬─────────────┤
│ 板载传感器                       │ 外接传感器              │
│ • AHT20温湿度                    │ • MAX30102心率血氧      │
│ • ICM-20608-G姿态                │ • ATGM336H GPS定位      │
│                                  │ • MQ2烟雾检测           │
├──────────────────────────────────┼─────────────────────────┤
│ 通信模块                          │ 云端服务                │
│ • ESP01S WiFi                    │ • 华为云IoT平台         │
│ • ASR-PRO语音                    │ • MQTT协议              │
└─────────────────────────────────┴─────────────────────────┘
```

---

## 第二部分：采购清单

### 2.1 必备硬件清单

#### 核心硬件（必须购买）

| 序号 | 名称 | 型号/规格 | 数量 | 参考价格 | 购买链接提示 |
|-----|------|----------|------|---------|------------|
| 1 | STM32开发板 | STM32F407VET6最小系统板 | 1 | ¥45-60 | 淘宝搜"STM32F407VET6" |
| 2 | DAP-Link调试器 | CMSIS-DAP/ST-Link V2 | 1 | ¥10-25 | 淘宝搜"DAP-Link" |
| 3 | 心率血氧传感器 | MAX30102模块 | 1 | ¥8-15 | 淘宝搜"MAX30102" |
| 4 | GPS模块 | ATGM336H | 1 | ¥25-35 | 淘宝搜"ATGM336H" |
| 5 | WiFi模块 | ESP01S + 烧录器 | 1 | ¥12-20 | 淘宝搜"ESP01S" |
| 6 | 语音模块 | 天问ASR-PRO | 1 | ¥30-45 | 淘宝搜"天问ASR-PRO" |
| 7 | 烟雾传感器 | MQ2模块 | 1 | ¥3-8 | 淘宝搜"MQ2传感器" |

**说明**：
- ⚠️ STM32F407VET6开发板已**板载AHT20温湿度传感器**和**ICM-20608-G姿态传感器**，无需额外购买
- ⚠️ DHT11和MPU6050已被板载传感器替代，**不要购买**

#### 供电与接线（必须购买）

| 序号 | 名称 | 型号/规格 | 数量 | 参考价格 | 用途 |
|-----|------|----------|------|---------|------|
| 8 | 锂电池组 | 18650电池2节+电池盒 | 1套 | ¥15-25 | 系统供电（7.4V）|
| 9 | 稳压模块 | AMS1117-3.3V | 2 | ¥2-5 | ESP01S专用供电 |
| 10 | 杜邦线 | 公对母/母对母各40根 | 2包 | ¥8-12 | 模块连接 |
| 11 | USB转TTL | CH340G模块 | 1 | ¥5-10 | 串口调试 |
| 12 | Type-C数据线 | 1米 | 1 | ¥5-10 | STM32供电/烧录 |

#### 可选硬件（建议购买）

| 序号 | 名称 | 型号/规格 | 数量 | 参考价格 | 用途 |
|-----|------|----------|------|---------|------|
| 13 | OLED显示屏 | 0.96寸SPI接口 | 1 | ¥10-18 | 实时显示数据 |
| 14 | SD卡模块 | Micro SD卡+读卡器 | 1套 | ¥8-15 | 历史数据存储 |
| 15 | 蜂鸣器模块 | 有源蜂鸣器 | 1 | ¥2-5 | 声音报警 |
| 16 | 继电器模块 | 双路5V继电器 | 1 | ¥5-10 | 控制LED/风扇 |
| 17 | 面包板 | 830孔 | 1 | ¥8-12 | 原型搭建 |
| 18 | 万用表 | 数字万用表 | 1 | ¥20-50 | 电路调试 |

**必备硬件总价**：约**¥180-280元**
**含可选硬件总价**：约**¥230-380元**

### 2.2 软件工具清单

#### 必备软件（免费）

| 序号 | 软件名称 | 版本 | 用途 | 下载链接 |
|-----|---------|------|------|---------|
| 1 | STM32CubeMX | 6.0+ | 图形化配置 | [官网](https://www.st.com/zh/development-tools/stm32cubemx.html) |
| 2 | Keil MDK-ARM | V5.37+ | 代码编译 | [官网](https://www.keil.com/download/product/) |
| 3 | 串口调试助手 | 任意 | 查看调试信息 | XCOM、SecureCRT等 |
| 4 | MQTTFX | 1.7.1 | MQTT测试 | [下载](https://mqttfx.jensd.de/index.php/download) |
| 5 | 天问语音工程师 | 最新版 | 语音配置 | [官网](http://twen51.com) |
| 6 | Git | 2.30+ | 版本控制 | [官网](https://git-scm.com/downloads) |

#### 推荐软件（免费）

| 序号 | 软件名称 | 用途 |
|-----|---------|------|
| 7 | Visual Studio Code | 代码编辑（可选） |
| 8 | PuTTY | SSH/串口工具 |
| 9 | Typora | Markdown编辑器 |

### 2.3 采购注意事项

#### 硬件采购避坑指南

**1. STM32F407VET6开发板**
- ✅ 确认是**LQFP100封装**（100引脚）
- ✅ 确认**板载AHT20和ICM-20608-G**传感器
- ✅ 确认有**外部8MHz晶振**
- ❌ 不要买F407ZET6（144引脚，引脚定义不同）
- ❌ 不要买F407VGT6（Flash只有1MB但引脚相同，可用但浪费）

**2. ESP01S WiFi模块**
- ✅ 购买时**一定要附带烧录器**（USB转串口）
- ✅ 确认已烧录**AT固件**（商家一般会烧好）
- ✅ 建议购买**带底座**的版本，方便插拔
- ⚠️ 如果是空片，需要自己烧录固件（参考硬件连接文档）

**3. MAX30102心率血氧传感器**
- ✅ 确认模块**已集成上拉电阻**（4.7kΩ）
- ✅ 有些模块带中断引脚（INT），建议购买
- ❌ 不要买MAX30100（老版本，精度较低）

**4. ATGM336H GPS模块**
- ✅ 确认带**陶瓷天线**（内置天线）或**外接天线接口**
- ✅ 建议购买**支持北斗+GPS双模**的版本
- ⚠️ 室内无法定位，调试时需要去室外

**5. 烟雾传感器MQ2**
- ✅ 模块已集成**负载电阻和比较器**
- ✅ 确认有AO（模拟输出）和DO（数字输出）两个引脚
- ⚠️ 需要**外部5V供电**，STM32的5V引脚电压不足

**6. 稳压模块AMS1117-3.3**
- ✅ 确认输出电流**≥800mA**（ESP01S峰值300mA）
- ✅ 建议购买**带散热片**的版本
- ✅ 输出端建议**并联470uF电容**（商家一般已焊好）

#### 预算建议

**最低配置**（仅核心功能）：约**¥180元**
- STM32开发板 + DAP-Link + MAX30102 + GPS + ESP01S + MQ2 + 基础线材

**推荐配置**（完整功能）：约**¥260元**
- 最低配置 + 语音模块 + 稳压模块 + 锂电池组

**豪华配置**（扩展功能）：约**¥350元**
- 推荐配置 + OLED + SD卡 + 蜂鸣器 + 继电器 + 面包板 + 万用表

---

## 第三部分：快速上手

### 3.1 首次使用准备

#### 步骤1: 检查硬件清单

收到硬件后，按照下表逐一核对：

- [ ] STM32F407VET6开发板 × 1
- [ ] DAP-Link调试器 × 1
- [ ] MAX30102模块 × 1
- [ ] ATGM336H GPS × 1
- [ ] ESP01S + 烧录器 × 1
- [ ] ASR-PRO语音模块 × 1
- [ ] MQ2烟雾传感器 × 1
- [ ] AMS1117稳压模块 × 2
- [ ] 杜邦线若干
- [ ] USB数据线 × 1

#### 步骤2: 安装软件工具

按顺序安装以下软件：

1. **安装Keil MDK-ARM V5**
   - 下载后运行安装程序
   - 安装路径建议：`C:\Keil_v5`（不要有中文路径）
   - 安装完成后需要激活（搜索"Keil激活教程"）

2. **安装STM32CubeMX**
   - 下载后运行安装程序
   - 首次启动会下载STM32F4固件包（约200MB，需要联网）

3. **安装串口调试助手**
   - 推荐XCOM（免费、简单）
   - 或使用SecureCRT（专业版）

4. **安装驱动程序**
   - DAP-Link驱动（自动安装）
   - USB转TTL驱动（CH340驱动）

#### 步骤3: 烧录测试程序

在连接所有传感器前，先测试STM32是否正常：

**3.1 下载示例程序**
```bash
git clone https://github.com/你的仓库/smart_helmet_f407.git
cd smart_helmet_f407
```

**3.2 打开Keil工程**
- 双击打开 `MDK-ARM/smart_helmet_f407.uvprojx`

**3.3 连接DAP-Link**
```
DAP-Link接线：
  3V3  → STM32 3.3V（仅检测，不供电）
  SWCLK → PA14
  SWDIO → PA13
  GND  → GND
```

**3.4 烧录程序**
- 给STM32上电（插USB线）
- 点击Keil的"Download"按钮
- 等待提示"Programming Done"

**3.5 验证程序运行**
- STM32板载LED（PC13）应该闪烁
- 串口助手（115200波特率）应该打印调试信息

### 3.2 硬件连接（分步进行）

**⚠️ 重要提醒**：
- 所有接线必须在**断电状态**下进行
- 每连接一个模块，先用万用表测量**是否短路**（VCC和GND之间电阻应>1kΩ）
- 连接完成后**仔细检查**，确认无误再上电

#### 第一步：连接板载传感器（无需接线）

STM32F407VET6开发板已**板载**以下传感器，无需额外接线：
- **AHT20温湿度传感器**（I2C1总线，地址0x70）
- **ICM-20608-G姿态传感器**（I2C1总线，地址0xD0）

**验证方法**：
烧录程序后，串口应该打印：
```
AHT20: OK
ICM20608: OK (WHO_AM_I=0xAF)
Temp: 25.3°C, Humi: 60.5%
Pitch: 0.5°, Roll: -1.2°
```

#### 第二步：连接MQ2烟雾传感器

**接线图**：
```
MQ2模块          STM32F407VET6
  VCC ────────→ 外部5V（不接STM32的5V！）
  GND ────────→ GND
  AO  ────────→ PA0 (ADC1_IN0)
  DO  ────────  (不接)
```

**供电方案**：
- 方案A：使用ASR-PRO语音模块的5V引脚
- 方案B：使用LM2596降压模块
- 方案C：使用移动电源5V输出

**验证方法**：
串口应该打印：
```
MQ2: 45.23 ppm, Alarm: 0
```

#### 第三步：连接MAX30102心率血氧传感器

**接线图**：
```
MAX30102         STM32F407VET6
  VCC ────────→ 5V
  GND ────────→ GND
  SCL ────────→ PB15 (GPIO)
  SDA ────────→ PB14 (GPIO)
  INT ────────→ PB13 (GPIO_Input)
```

**验证方法**：
- 手指紧贴传感器（不要按太紧）
- 等待5-10秒
- 串口打印：
```
HR: 75 bpm, SpO2: 98%, HR_Alarm: 0, SpO2_Alarm: 0
```

#### 第四步：连接ATGM336H GPS模块

**接线图**（注意TX/RX交叉连接）：
```
ATGM336H         STM32F407VET6
  VCC ────────→ 5V
  GND ────────→ GND
  TX  ────────→ PA3 (USART2_RX) ← GPS的TX接STM32的RX
  RX  ────────→ PA2 (USART2_TX) ← GPS的RX接STM32的TX
```

**验证方法**：
- **必须在室外空旷处测试**
- 冷启动需等待1-3分钟
- GPS模块LED指示灯：慢闪（搜星）→快闪（定位成功）
- 串口打印：
```
GPS: Lat=39.908700N, Lon=116.397500E
```

#### 第五步：连接ESP01S WiFi模块

**⚠️ 关键**：ESP01S**必须外部3.3V稳压供电**，不能直接接STM32的3.3V引脚！

**接线图**：
```
ESP01S           AMS1117-3.3      STM32F407VET6
  VCC ────────→ OUT
  GND ────────→ GND ──────────→ GND
  TX  ─────────────────────────→ PB11 (USART3_RX)
  RX  ─────────────────────────→ PB10 (USART3_TX)
  CH_PD ───────→ VCC (必须接高)
  GPIO0 ───────  (悬空或接高)
  GPIO2 ───────  (悬空或接高)

AMS1117-3.3:
  IN ──────────→ 外部5V（电池或移动电源）
  OUT ─────────→ ESP01S VCC
  GND ─────────→ GND（共地）
```

**验证方法**：
- 给ESP01S单独上电
- 串口发送 `AT\r\n`，应返回 `OK`
- 串口打印：
```
ESP01S: WiFi connected
MQTT: Connected to Huawei Cloud
```

#### 第六步：连接ASR-PRO语音模块

**接线图**：
```
ASR-PRO          STM32F407VET6
  VCC ────────→ 5V
  GND ────────→ GND
  PA2 ────────→ PA10 (USART1_RX) ← ASR的PA2是TX
  PA3 ────────→ PA9  (USART1_TX) ← ASR的PA3是RX
  PA5 ────────→ (可选：继电器2)
  PA6 ────────→ (可选:继电器1)
```

**验证方法**：
- 对着语音模块说"打开电灯"
- 串口打印：
```
ASR: Received command 0x01
```

### 3.3 首次上电检查清单

在首次上电前，请逐项检查：

#### 供电检查
- [ ] 所有VCC连接正确（3.3V的接3.3V，5V的接5V）
- [ ] 所有GND已共地（用万用表测量任意两个GND引脚，电阻应为0Ω）
- [ ] ESP01S已外部3.3V供电（不是STM32的3.3V）
- [ ] MQ2已外部5V供电（不是STM32的5V）

#### 接线检查
- [ ] TX/RX没有接反（GPS、ESP01S、ASR-PRO）
- [ ] 软件I2C引脚正确（MAX30102的SCL→PB15, SDA→PB14）
- [ ] ADC引脚正确（MQ2的AO→PA0）
- [ ] ESP01S的CH_PD已接VCC

#### 短路检查
- [ ] 用万用表测量VCC与GND之间电阻>1kΩ（如果<100Ω说明短路）
- [ ] 目视检查无明显的线材交叉或裸露金属接触

#### 上电顺序
1. 先给STM32上电（USB或电池）
2. 再给ESP01S单独上电（通过AMS1117）
3. 最后连接DAP-Link（如果需要调试）

### 3.4 首次运行测试

**测试程序功能**：

1. **LED闪烁测试**
   - PC13 LED应该每500ms闪烁一次
   - 说明主程序和调度器运行正常

2. **串口输出测试**
   - 打开串口助手（115200波特率）
   - 应该持续打印各传感器数据

3. **板载传感器测试**
   ```
   [预期输出]
   AHT20: Temp=25.3°C, Humi=60.5%
   ICM20608: Pitch=0.5°, Roll=-1.2°, Fall=0
   ```

4. **MQ2测试**
   ```
   [预期输出]
   MQ2: 45.23 ppm, Alarm: 0

   [用打火机测试]
   在MQ2附近打火，数值应升高
   MQ2: 250.67 ppm, Alarm: 1
   ```

5. **MAX30102测试**
   ```
   [无手指时]
   HR: 0 bpm, SpO2: 0%, HR_Alarm: 0

   [手指贴紧时，等待5-10秒]
   HR: 75 bpm, SpO2: 98%, HR_Alarm: 0
   ```

6. **GPS测试**（室外）
   ```
   [搜星中]
   GPS: Lat=0.000000N, Lon=0.000000E

   [定位成功后]
   GPS: Lat=39.908700N, Lon=116.397500E
   ```

7. **WiFi连接测试**
   ```
   [预期输出]
   ESP01S: Connecting to WiFi...
   ESP01S: WiFi connected
   ESP01S: IP=192.168.1.100
   MQTT: Connecting...
   MQTT: Connected to Huawei Cloud
   ```

8. **语音识别测试**
   ```
   [说"打开电灯"]
   ASR: Received command 0x01
   Relay 1: ON

   [说"关闭电灯"]
   ASR: Received command 0x02
   Relay 1: OFF
   ```

---

## 第四部分：功能使用

### 4.1 环境监测功能

#### 温湿度监测（AHT20）

**数据含义**：
- **温度**：环境温度，单位℃
- **湿度**：相对湿度，单位%RH

**正常范围**：
- 温度：-40°C ~ 85°C
- 湿度：0% ~ 100%

**使用场景**：
- 工地环境舒适度监测
- 矿井湿度过高报警
- 高温作业环境预警

**串口输出示例**：
```
AHT20: Temp=28.5°C, Humi=65.2%
```

#### 烟雾浓度监测（MQ2）

**数据含义**：
- **ppm**：烟雾浓度，单位ppm（百万分之一）
- **Alarm**：报警标志（0=正常，1=超标）

**阈值设置**：
- 正常环境：<100 ppm
- 轻度污染：100-300 ppm
- 中度污染：300-500 ppm（触发报警）
- 重度污染：>500 ppm（紧急撤离）

**使用场景**：
- 检测火灾烟雾
- 检测天然气泄漏
- 检测有毒气体

**串口输出示例**：
```
MQ2: 45.23 ppm, Alarm: 0  (正常)
MQ2: 350.67 ppm, Alarm: 1 (报警)
```

**注意事项**：
- MQ2需要预热1-2分钟
- 清洁环境中校准R0值
- 定期更换传感器（使用寿命约2-3年）

### 4.2 健康监测功能

#### 心率血氧监测（MAX30102）

**数据含义**：
- **HR**：心率，单位bpm（次/分钟）
- **SpO2**：血氧饱和度，单位%

**正常范围**：
- 心率：60-100 bpm（成年人静息心率）
- 血氧：95%-100%

**异常判断**：
- 心率过低：<60 bpm（心动过缓）
- 心率过高：>100 bpm（心动过速）
- 血氧过低：<95%（缺氧）

**使用方法**：
1. 将手指紧贴MAX30102传感器
2. 不要按太紧（会阻断血液流动）
3. 保持静止，等待5-10秒
4. 数据稳定后读数

**串口输出示例**：
```
HR: 75 bpm, SpO2: 98%, HR_Alarm: 0, SpO2_Alarm: 0  (正常)
HR: 110 bpm, SpO2: 92%, HR_Alarm: 1, SpO2_Alarm: 1 (异常)
```

**注意事项**：
- 手指要覆盖红光和红外LED
- 不要戴手套
- 指甲油会影响测量
- 测量精度：心率±5bpm，血氧±2%（仅供参考）

### 4.3 姿态监测功能

#### 摔倒检测（ICM-20608-G）

**数据含义**：
- **Pitch**：俯仰角，单位度（°）
- **Roll**：翻滚角，单位度（°）
- **Fall**：摔倒标志（0=正常，1=摔倒）

**检测原理**：
- 正常站立：Pitch≈0°，Roll≈0°
- 正常行走：Pitch约±10°，Roll约±5°
- 摔倒瞬间：Pitch或Roll超过60°

**使用场景**：
- 高空作业摔倒检测
- 老人跌倒监测
- 运动员碰撞检测

**串口输出示例**：
```
ICM20608: Pitch=2.5°, Roll=-1.2°, Fall=0  (正常)
ICM20608: Pitch=75.3°, Roll=12.5°, Fall=1 (摔倒)
```

**测试方法**：
- 将安全帽倾斜超过60度
- 系统应触发摔倒报警
- 语音模块播报"检测到跌倒"

### 4.4 定位追踪功能

#### GPS定位（ATGM336H）

**数据含义**：
- **Lat**：纬度，北纬为正，南纬为负
- **Lon**：经度，东经为正，西经为负

**数据格式**：
- 十进制度数格式：39.908700°N
- 百度/高德地图可直接搜索

**定位精度**：
- 民用GPS：约5-10米
- 北斗+GPS双模：约3-5米

**冷启动时间**：
- 首次开机：1-3分钟
- 短时间断电（<4小时）：30-60秒
- 刚断电重启：<10秒

**使用方法**：
1. **必须在室外空旷处**使用
2. 天线面朝上，上方无遮挡
3. 等待GPS模块LED快闪（定位成功）
4. 读取坐标数据

**串口输出示例**：
```
GPS: Lat=0.000000N, Lon=0.000000E  (未定位)
GPS: Lat=39.908700N, Lon=116.397500E (已定位)
```

**坐标查看**：
- 复制坐标：`39.908700,116.397500`
- 在百度地图搜索框粘贴
- 可查看实时位置

**注意事项**：
- 室内无法定位（混凝土屏蔽信号）
- 不要靠近金属物体
- 阴天/雨天定位时间会延长

### 4.5 语音交互功能

#### 语音控制（ASR-PRO）

**支持的控制指令**：

| 词条 | 功能 | 反馈 |
|-----|------|------|
| "打开电灯" | 控制继电器1闭合 | LED点亮 |
| "关闭电灯" | 控制继电器1断开 | LED熄灭 |
| "打开风扇" | 控制继电器2闭合 | 风扇启动 |
| "关闭风扇" | 控制继电器2断开 | 风扇停止 |
| "测量心率" | 触发心率测量 | 测量5秒后播报结果 |
| "取消报警" | 关闭异常报警 | 报警静音10秒 |

**语音播报功能**：

| 触发条件 | 播报内容 |
|---------|---------|
| 检测到摔倒 | "检测到跌倒" |
| 烟雾浓度超标 | "检测到浓度过高" |
| 心率异常 | "心率异常" |
| 血氧过低 | "血氧异常" |

**使用方法**：
1. 对着语音模块清晰说出指令
2. 距离0.5-3米
3. 环境安静（噪音<60dB）
4. 等待模块识别（约500ms）

**识别成功标志**：
- 串口打印识别结果
- 继电器动作（如果是控制指令）
- 语音播报反馈

**注意事项**：
- 离线识别，无需联网
- 识别率约90%（安静环境）
- 嘈杂环境识别率会下降

### 4.6 数据上云功能

#### 华为云IoT平台

**上传的数据**：

**批次1：传感器数据**（350ms上传一次）
```json
{
  "services": [{
    "service_id": "BasicData",
    "properties": {
      "spO2": 98,
      "propane_concentration": 45.23,
      "heart_rate": 75,
      "fall_flag": 0
    }
  }]
}
```

**批次2：环境数据**（1000ms上传一次）
```json
{
  "services": [{
    "service_id": "BasicData",
    "properties": {
      "longitude": 116.397500,
      "latitude": 39.908700,
      "temperature": 25,
      "humidity": 60
    }
  }]
}
```

**查看云端数据**：
1. 登录华为云IoT平台
2. 进入"设备"→"所有设备"
3. 点击你的设备名称
4. 查看"设备详情"→"属性"
5. 实时数据会自动刷新

**数据导出**：
- 云端可导出历史数据（CSV格式）
- 可用于数据分析、绘制图表

**串口输出示例**：
```
ESP01S: Uploading data...
MQTT: Publish success
Cloud: Data received
```

---

## 第五部分：故障排查

### 5.1 常见问题诊断流程

#### 问题1: STM32上电无反应

**现象**：
- 板载LED不亮
- 串口无输出
- 无法烧录程序

**排查步骤**：
```
1. 检查供电
   ├─ 用万用表测量5V引脚电压
   │  ├─ 正常：4.8V-5.2V
   │  └─ 异常：<4V或>5.5V → 更换电源
   │
2. 检查BOOT0跳线
   ├─ 应该接GND（正常模式）
   └─ 如果接3.3V → 会进入下载模式，无法运行程序
   │
3. 检查晶振
   ├─ 用示波器测量晶振引脚（PH0/PH1）
   └─ 应该有8MHz正弦波
   │
4. 检查复位
   ├─ 按下复位按钮，松开后应重启
   └─ 如果无反应 → 可能复位电路损坏
```

**解决方案**：
- 如果是BOOT0问题 → 调整跳线帽
- 如果是供电问题 → 更换USB线或电源
- 如果是晶振问题 → 联系商家更换开发板

---

#### 问题2: ESP01S频繁重启

**现象**：
- 串口不断输出乱码
- 或打印"ets Jan 8 2013..."
- WiFi无法连接

**原因**：供电不足！

**排查步骤**：
```
1. 检查供电来源
   ├─ 如果接STM32的3.3V → ❌ 错误！
   └─ 应该用AMS1117外部供电
   │
2. 用示波器测量ESP01S的VCC引脚
   ├─ WiFi发送时电压应≥3.0V
   └─ 如果跌到<2.8V → 供电不足
   │
3. 检查稳压模块
   ├─ AMS1117输入电压应≥4.5V
   └─ 输出电流应≥500mA
```

**解决方案**：
```c
// 方案1：使用AMS1117稳压模块
电池5V → AMS1117 IN
AMS1117 OUT → ESP01S VCC
AMS1117 GND → GND（共地）

// 方案2：在输出端并联大电容
AMS1117 OUT ─┬→ ESP01S VCC
             │
           [470uF]
             │
            GND
```

---

#### 问题3: GPS无法定位

**现象**：
- GPS模块LED慢闪（搜星中）
- 串口一直输出 `Lat=0.000000N, Lon=0.000000E`

**排查步骤**：
```
1. 确认测试环境
   ├─ 室内？ → ❌ GPS在室内无法定位
   └─ 室外？ → ✅ 继续排查
   │
2. 检查天线朝向
   ├─ 天线面应该朝上
   └─ 上方不能有遮挡物（树、建筑）
   │
3. 等待足够时间
   ├─ 冷启动需1-3分钟
   └─ 热启动需<10秒
   │
4. 检查串口连接
   ├─ TX/RX是否接反？
   │  GPS TX → STM32 RX (PA3)
   │  GPS RX → STM32 TX (PA2)
   └─ 波特率是否正确？（应为9600）
   │
5. 查看原始NMEA数据
   ├─ 用串口助手直连GPS模块
   └─ 应该看到$GNRMC或$GNGGA开头的语句
```

**解决方案**：
- 如果室内 → 拿到室外空旷处
- 如果TX/RX接反 → 交换线序
- 如果无原始数据 → 检查GPS模块是否损坏

---

#### 问题4: MAX30102无数据

**现象**：
- 手指贴紧传感器
- 串口一直输出 `HR: 0 bpm, SpO2: 0%`

**排查步骤**：
```
1. 检查手指接触
   ├─ 手指是否完全覆盖LED？
   ├─ 是否按得太紧？（会阻断血液）
   └─ 是否戴了手套或有指甲油？
   │
2. 检查软件I2C接线
   ├─ SCL → PB15 ✅
   ├─ SDA → PB14 ✅
   └─ 是否接反？
   │
3. 测试I2C通信
   ├─ 读取器件ID（寄存器0xFF）
   └─ 应返回0x15（MAX30102的ID）
   │
4. 检查LED电流
   ├─ 默认7mA（暗）
   └─ 可调到24mA（亮）
```

**测试代码**：
```c
// 读取器件ID
uint8_t id = MAX30102_Read_Reg(0xFF);
if(id == 0x15) {
    printf("MAX30102: OK\r\n");
} else {
    printf("MAX30102: FAIL (ID=0x%02X)\r\n", id);
}
```

**解决方案**：
- 如果ID读取失败 → 检查I2C接线
- 如果LED不亮 → 增大LED电流
- 如果数据跳变严重 → 启用滤波算法

---

#### 问题5: I2C传感器无响应

**现象**：
- AHT20或ICM20608初始化失败
- 串口打印 `AHT20: FAIL` 或 `ICM20608: FAIL`

**排查步骤**：
```
1. 扫描I2C总线
   for(uint8_t addr = 0; addr < 128; addr++) {
       if(HAL_I2C_IsDeviceReady(&hi2c1, addr<<1, 1, 10) == HAL_OK) {
           printf("Found device at 0x%02X\r\n", addr);
       }
   }
   // 应该找到0x38(AHT20)和0x68(ICM20608)

2. 检查I2C地址
   ├─ AHT20: 0x70（写地址）= 0x38<<1
   └─ ICM20608: 0xD0（写地址）= 0x68<<1
   │
3. 检查上拉电阻
   ├─ 板载开发板通常已集成4.7kΩ上拉
   └─ 用万用表测量SCL/SDA到3.3V的电阻
   │
4. 检查I2C速度
   ├─ 建议400kHz（Fast Mode）
   └─ 如果失败，尝试100kHz（Standard Mode）
```

**解决方案**：
- 如果扫描不到设备 → 检查焊接是否良好
- 如果地址不对 → 修改代码中的I2C_ADDR宏定义
- 如果无上拉电阻 → 外接4.7kΩ电阻到3.3V

---

#### 问题6: MQ2数据一直是4095

**现象**：
- ADC读数一直是最大值4095
- 或者一直是0

**排查步骤**：
```
1. 检查接线
   ├─ AO引脚是否连接到PA0？
   └─ VCC是否有5V供电？
   │
2. 测量MQ2输出电压
   ├─ 用万用表测量AO引脚电压
   ├─ 正常：0.5V-2.5V
   ├─ 异常：0V → 未供电或模块损坏
   └─ 异常：5V → 传感器开路
   │
3. 检查ADC配置
   ├─ 通道是否为ADC1_IN0？
   ├─ 采样时间是否足够？（建议480 Cycles）
   └─ DMA是否启动？
```

**测试代码**：
```c
// 读取原始ADC值
printf("ADC Raw: %d\r\n", adc_buffer[0]);
// 转换为电压
float voltage = adc_buffer[0] * 3.3f / 4095.0f;
printf("Voltage: %.2f V\r\n", voltage);
```

**解决方案**：
- 如果ADC=4095 → 检查AO是否悬空
- 如果ADC=0 → 检查VCC供电
- 如果电压>3.3V → 增加分压电阻保护PA0

---

#### 问题7: 数据无法上传到华为云

**现象**：
- 串口打印 `MQTT: Connection failed`
- 或 `MQTT: Publish error`

**排查步骤**：
```
1. 检查WiFi连接
   ├─ 发送 AT+CWJAP? 查询当前WiFi
   └─ 应返回连接的WiFi名称和IP
   │
2. 检查MQTT参数
   ├─ 服务器地址是否正确？
   ├─ 端口是否为1883或8883？
   ├─ ClientID/Username/Password是否正确？
   └─ 设备是否在华为云平台注册？
   │
3. 测试MQTT连接（使用MQTTFX）
   ├─ 在电脑上用相同参数连接
   └─ 确认是否能成功连接
   │
4. 查看华为云设备状态
   ├─ 登录华为云IoT平台
   ├─ 查看设备是否在线
   └─ 查看"设备日志"中的错误信息
```

**常见错误码**：
| 错误码 | 含义 | 解决方案 |
|-------|------|---------|
| -1 | 连接超时 | 检查网络、服务器地址 |
| -2 | 认证失败 | 检查Username/Password |
| -3 | 客户端ID重复 | 修改ClientID |
| -4 | 发布失败 | 检查Topic和JSON格式 |

**解决方案**：
```c
// 重新配置MQTT
AT+MQTTUSERCFG=0,1,"NULL","设备ID","设备密钥",0,0,""
AT+MQTTCLIENTID=0,"ClientID"
AT+MQTTCONN=0,"服务器地址",1883,1

// 测试发布
AT+MQTTPUB=0,"$oc/devices/设备ID/sys/properties/report","{\"test\":123}",0,0
```

---

### 5.2 调试技巧

#### 使用串口调试

**查看实时数据**：
```c
// 在main.c的while循环中
printf("==================== System Status ====================\r\n");
printf("Temp: %.1f°C, Humi: %.1f%%\r\n", temperature, humidity);
printf("Pitch: %.1f°, Roll: %.1f°, Fall: %d\r\n", pitch, roll, fall_flag);
printf("MQ2: %.2f ppm, Alarm: %d\r\n", ppm, density_flag);
printf("HR: %d bpm, SpO2: %d%%, Alarms: %d/%d\r\n", hr, spo2, hr_alarm, spo2_alarm);
printf("GPS: Lat=%.6f%c, Lon=%.6f%c\r\n", lat, ns, lon, ew);
printf("WiFi: %s, MQTT: %s\r\n", wifi_status, mqtt_status);
printf("=======================================================\r\n\r\n");
HAL_Delay(1000);
```

#### 使用逻辑分析仪

**抓取I2C波形**：
1. 连接逻辑分析仪到SCL/SDA引脚
2. 设置采样率：≥4MHz
3. 添加I2C协议解析器
4. 触发条件：起始信号（SDA下降沿）
5. 查看解码数据：地址、数据、应答位

**分析要点**：
- 起始信号：SCL高时SDA下降沿
- 停止信号：SCL高时SDA上升沿
- 应答位：第9个时钟周期SDA应为低（ACK）
- 时钟频率：Standard 100kHz或Fast 400kHz

#### 使用示波器

**测量电源波动**：
```
1. 探头接ESP01S的VCC引脚
2. 地线接GND
3. 触发方式：单次触发
4. 触发条件：电压<3.0V
5. 观察ESP01S发送数据时的电压跌落
   ├─ 正常：≥3.0V
   └─ 异常：<2.8V → 供电不足
```

**测量I2C时序**：
```
1. CH1接SCL，CH2接SDA
2. 触发方式：边沿触发
3. 触发源：CH2（SDA）
4. 触发条件：下降沿
5. 测量参数：
   ├─ SCL高电平时间：≥4us
   ├─ SCL低电平时间：≥4us
   └─ SDA建立时间：≥250ns
```

---

## 第六部分：常见问题

### 6.1 硬件相关

**Q1: STM32F407和F103有什么区别？**

| 特性 | F103C8T6 | F407VET6 | 提升 |
|-----|----------|----------|------|
| Flash | 64KB | 512KB | 8倍 |
| RAM | 20KB | 128KB | 6.4倍 |
| 主频 | 72MHz | 168MHz | 2.3倍 |
| GPIO | 37个 | 82个 | 2倍+ |
| FPU | 无 | 单精度 | 硬件加速 |

**Q2: 能用3.3V给ESP01S供电吗？**

❌ **不能！** 必须用外部稳压模块。

原因：
- ESP01S峰值电流300mA
- STM32的3.3V引脚最大输出150mA
- 供电不足会导致ESP01S反复重启

**Q3: MQ2可以用STM32的5V引脚供电吗？**

❌ **不推荐！**

原因：
- MQ2工作电流150mA
- STM32的5V引脚实测只有4.7V，且电流不足
- 建议外部供电或使用ASR-PRO的5V引脚

**Q4: 能不能只用一个I2C总线连接所有传感器？**

✅ **可以，但有限制。**

- AHT20和ICM20608已共享I2C1（板载）
- MAX30102使用软件I2C（因硬件I2C已占用）
- 理论上可以所有I2C设备共享一个总线，但需要：
  - 确保地址不冲突
  - 注意总线负载（最多挂16个设备）
  - 上拉电阻可能需要调整

**Q5: GPS在室内能定位吗？**

❌ **不能。**

原因：
- GPS信号频率1.5GHz，穿透力弱
- 混凝土墙壁会完全屏蔽信号
- 必须在室外空旷处使用

替代方案：
- 增加WiFi定位（基于IP或热点）
- 增加基站定位（需要GSM模块）

### 6.2 软件相关

**Q6: 为什么用调度器而不用RTOS？**

**优势**：
- ✅ 代码简单，易于理解
- ✅ 资源占用少（<100字节RAM）
- ✅ 无需移植RTOS内核
- ✅ 适合本项目的9个任务

**劣势**：
- ❌ 无优先级，紧急任务可能延迟
- ❌ 任务不能阻塞（需状态机实现）
- ❌ 不适合硬实时系统

**Q7: 如何修改数据上传频率？**

修改 `scheduler.c` 中的任务周期：

```c
static task_t tasks[] = {
    {esp_report1, 350, 0},  // 350ms上传一次传感器数据
    {esp_report2, 1000, 0}, // 1000ms上传一次环境数据
};

// 修改为更低频率（省电）
static task_t tasks[] = {
    {esp_report1, 1000, 0},  // 改为1秒上传一次
    {esp_report2, 5000, 0},  // 改为5秒上传一次
};
```

**Q8: 如何添加新的传感器？**

**步骤**：
1. 编写传感器驱动（参考aht20.c）
2. 在main.c中初始化传感器
3. 在scheduler.c中添加任务

```c
// 1. 创建传感器任务函数
void new_sensor_task(void) {
    // 读取传感器数据
    // 处理数据
    // 打印或上传
}

// 2. 添加到任务列表
static task_t tasks[] = {
    // ... 已有任务
    {new_sensor_task, 100, 0},  // 100ms周期
};
```

**Q9: 如何修改摔倒检测阈值？**

修改 `icm20608_task.c` 中的阈值：

```c
// 原阈值：60度
if(fabs(pitch) > 60.0f || fabs(roll) > 60.0f) {
    fall_flag = true;
}

// 修改为更敏感（45度）
if(fabs(pitch) > 45.0f || fabs(roll) > 45.0f) {
    fall_flag = true;
}

// 修改为更宽松（80度）
if(fabs(pitch) > 80.0f || fabs(roll) > 80.0f) {
    fall_flag = true;
}
```

**Q10: 如何优化心率测量精度？**

**方法1：调整LED电流**
```c
// 在max30102.c中
MAX30102_Write_Reg(REG_LED1_PA, 0x24);  // 默认7mA
// 改为更亮（适合手指偏厚）
MAX30102_Write_Reg(REG_LED1_PA, 0x3F);  // 12.5mA
```

**方法2：增加采样数**
```c
#define BUFFER_LENGTH 500  // 默认500个样本（约5秒）
// 改为更多样本（更准确但更慢）
#define BUFFER_LENGTH 1000  // 1000个样本（约10秒）
```

**方法3：调整滤波参数**
```c
#define WINDOW_SIZE 20  // 滑动平均窗口
#define ALPHA 0.05f     // 低通滤波系数

// 更强的滤波（更平滑但响应慢）
#define WINDOW_SIZE 30
#define ALPHA 0.02f
```

### 6.3 云平台相关

**Q11: 如何注册华为云IoT账号？**

**步骤**：
1. 访问 https://www.huaweicloud.com
2. 点击"免费注册"
3. 填写手机号/邮箱
4. 完成实名认证（需要身份证）
5. 进入"IoT设备接入"服务

**新用户福利**：
- 免费试用3个月
- 赠送100万条消息
- 足够本项目测试使用

**Q12: 如何查看华为云上的数据？**

**步骤**：
1. 登录华为云IoT平台
2. 进入"设备" → "所有设备"
3. 点击设备名称
4. 查看"设备详情" → "属性"
5. 实时数据会自动刷新（每1-5秒）

**Q13: 如何导出历史数据？**

**步骤**：
1. 在设备详情页，点击"历史数据"
2. 选择时间范围（最多30天）
3. 点击"导出"
4. 选择CSV或Excel格式
5. 下载到本地

**Q14: MQTT连接失败怎么办？**

**常见原因**：
1. WiFi未连接 → 检查SSID/密码
2. 服务器地址错误 → 复制粘贴（避免手打）
3. 设备ID/密钥错误 → 重新获取
4. ClientID格式错误 → 参考官方文档

**验证方法**：
```bash
# 使用MQTTFX测试连接
Broker Address: xxxx.iot-mqtts.cn-north-4.myhuaweicloud.com
Port: 1883
Client ID: ProductID_NodeId_0_0_2025031607
Username: DeviceID
Password: 设备密钥

# 连接成功后，发布测试消息
Topic: $oc/devices/DeviceID/sys/properties/report
Message: {"test": 123}
```

### 6.4 项目扩展

**Q15: 如何添加OLED显示屏？**

**步骤**：
1. 购买0.96寸SPI接口OLED（SSD1306芯片）
2. 连接到SPI1总线（已配置）
   ```
   OLED CS  → PA4
   OLED CLK → PA5
   OLED MOSI→ PA7
   OLED DC  → PC4（需新增GPIO）
   OLED RES → PC5（需新增GPIO）
   ```
3. 下载OLED驱动库（GitHub搜"SSD1306 STM32"）
4. 在main.c中初始化并显示数据

**Q16: 如何增加SD卡存储？**

**步骤**：
1. 购买Micro SD卡模块（支持SPI或SDIO）
2. 本项目已配置SDIO接口
   ```
   SD_D0 → PC8
   SD_D1 → PC9
   SD_D2 → PC10
   SD_D3 → PC11
   SD_CLK→ PC12
   SD_CMD→ PD2
   ```
3. 在CubeMX中启用FATFS中间件
4. 创建文件系统，记录历史数据

**示例代码**：
```c
// 记录数据到SD卡
char log_buffer[256];
sprintf(log_buffer, "%s,%.1f,%.1f,%d,%d\r\n",
        timestamp, temperature, humidity, heart_rate, spO2);
f_write(&file, log_buffer, strlen(log_buffer), &bw);
```

**Q17: 如何降低功耗延长续航？**

**方法1：进入STOP模式**
```c
// 无人佩戴时进入低功耗模式
if(no_user_detected) {
    HAL_PWR_EnterSTOPMode(PWR_LOWPOWERREGULATOR_ON, PWR_STOPENTRY_WFI);
}
```

**方法2：降低采样频率**
```c
// 非关键时刻降低任务频率
static task_t tasks[] = {
    {aht20_task, 1000, 0},   // 从100ms改为1000ms
    {max30102_task, 5000, 0},// 从200ms改为5000ms
};
```

**方法3：关闭不用的外设**
```c
// 关闭UART时钟
__HAL_RCC_USART1_CLK_DISABLE();
__HAL_RCC_USART2_CLK_DISABLE();
```

**预期效果**：
- 原续航：2-3小时（满载）
- 优化后：8-10小时（间歇采样）

---

## 📞 技术支持

### 获取帮助的途径

1. **查看项目文档**
   - 01-开发流程文档.md
   - 02-硬件连接文档.md
   - 03-面试问答宝典.md
   - 04-用户使用手册.md（本文档）

2. **在线资源**
   - STM32中文社区：https://www.stmcu.org.cn
   - 正点原子论坛：http://www.openedv.com/forum.php
   - 野火电子论坛：http://www.firebbs.cn

3. **GitHub Issues**
   - 提交Bug报告
   - 请求新功能
   - 分享你的改进

4. **联系方式**
   - 项目仓库：https://github.com/你的仓库/smart_helmet_f407
   - 邮箱：your_email@example.com

### 反馈与改进

如果你在使用过程中发现问题或有改进建议，欢迎：
- 提交Issue
- 发起Pull Request
- 分享你的使用心得

---

**祝你使用愉快！** 🎉

---

**文档版本**: v1.0
**最后更新**: 2025年
**作者**: STM32智能安全帽项目组
