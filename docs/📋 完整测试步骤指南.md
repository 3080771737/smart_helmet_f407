# 📋 STM32智能安全帽 - 完整测试步骤指南

> **测试前必读**：本文档提供从硬件连接到功能验证的完整测试流程
> **适用板卡**：STM32F407VET6
> **调试工具**：DAPLink/CMSIS-DAP
> **最后更新**：2025-12-03

---

## 🎯 **测试目标**

验证以下5个传感器模块是否正常工作：
1. ✅ MAX30102 心率血氧传感器
2. ✅ MQ2 烟雾传感器
3. ✅ ATGM336H GPS定位模块
4. ✅ ESP01S WiFi模块
5. ⚠️ ASR-PRO 语音模块（暂时跳过，稍后实现）

---

## 📝 **测试前准备清单**

### **必需硬件：**
```
□ STM32F407VET6 开发板 × 1
□ DAPLink/STLink 调试器 × 1
□ 电源模块（面包板电源或独立模块）× 1
□ DC 9V/12V 适配器（至少1A）× 1
□ USB数据线 × 2根（STM32供电 + DAPLink）
□ 杜邦线若干（公对公、公对母）

传感器模块：
□ MAX30102 心率血氧传感器
□ MQ2 烟雾传感器
□ ATGM336H GPS模块
□ ESP01S WiFi模块
□ ASR-PRO 语音模块（本次测试可不连接）
```

### **必需软件：**
```
□ Keil MDK-ARM (μVision5)
□ Git（用于拉取最新代码）
□ 万用表（用于检查供电电压）
```

---

## ⚠️ **阶段0：测试前必须修改的配置（5分钟）**

### **🔧 修改WiFi和MQTT配置（重要！）**

**如果不修改，ESP01S会一直连不上WiFi！**

打开文件：`F:\RT\smart_helmet_f407\APP\esp01s.h`

找到第28-40行，修改以下配置：

```c
/* ==================== 配置参数（需要用户修改）==================== */

// WiFi配置 ← 修改这里！
#define WIFI_SSID           "你家的WiFi名称"      // 例如："TP-LINK_1234"
#define WIFI_PASSWORD       "你家的WiFi密码"      // 例如："12345678"

// MQTT配置（如果暂时不用云平台，可以先不改）
#define MQTT_SERVER         "your-server.iot-mqtts.cn-north-4.myhuaweicloud.com"
#define MQTT_PORT           1883
#define MQTT_CLIENT_ID      "ProductID_NodeId_0_0_2025031607"
#define MQTT_USERNAME       "your_device_id"
#define MQTT_PASSWORD       "your_device_secret"
#define MQTT_TOPIC          "$oc/devices/your_device_id/sys/properties/report"
```

**修改示例：**

```c
// WiFi配置（修改后）
#define WIFI_SSID           "TP-LINK_8888"        // 改成你家WiFi名称
#define WIFI_PASSWORD       "mypassword123"       // 改成你家WiFi密码

// MQTT配置（暂时不用可以不改，程序会跳过MQTT连接失败）
```

**保存文件后，记得在Keil中重新编译（F7）！**

---

## 📦 **阶段1：硬件连接（30分钟）**

### **第1步：供电系统连接**

#### **1.1 电源模块连接**

```
DC适配器 (9V/12V 1A)
    ↓
电源模块的绿色端子
    [+红线] [-黑线]
    ↓
电源模块输出：
    蓝色端子孔位1、2 → 3.3V输出
    蓝色端子孔位3、6 → GND输出
    蓝色端子孔位4、5 → 5V输出
```

**检查：**
- ✅ 拧紧绿色端子螺丝
- ✅ 打开电源模块红色开关
- ✅ 用万用表测量：
  - 孔位1 → 3.3V (±0.1V)
  - 孔位4 → 5.0V (±0.2V)

---

### **第2步：STM32开发板供电**

```
STM32F407开发板
    ↓
USB线连接电脑（或5V充电器）
    ↓
开发板上的LED应该亮起
```

**检查：**
- ✅ USB插牢固
- ✅ 开发板LED亮起
- ✅ 用万用表测量开发板的3.3V引脚 = 3.3V

---

### **第3步：DAPLink调试器连接**

```
DAPLink/STLink         STM32F407
┌──────────┐          ┌──────────┐
│ SWDIO  ●─────红线────→ PA13    │
│ SWCLK  ●─────黄线────→ PA14    │
│ GND    ●─────黑线────→ GND     │
│ 3.3V   ●─────────────→ 不接    │
└──────────┘          └──────────┘
     ↑
   USB连电脑
```

**⚠️ 注意：**
- SWDIO/SWCLK不能接反！
- GND必须连接（共地）
- 3.3V不用接（STM32已经有USB供电）

---

### **第4步：传感器模块连接（混合供电方案）**

#### **📌 供电原则：**
- **低功耗模块** → 从STM32板子取电
- **高功耗模块** → 从电源模块取电
- **⚠️ 必须共地！**

---

#### **4.1 MAX30102 心率血氧传感器**

```
MAX30102              STM32F407
  VCC ──红线(公对母)──→ 3.3V引脚
  GND ──黑线(公对母)──→ GND引脚
  SCL ──黄线(公对公)──→ PB14引脚
  SDA ──绿线(公对公)──→ PB15引脚
  INT ──不接
```

**功耗：50mA @ 3.3V （从STM32取电）**

---

#### **4.2 MQ2 烟雾传感器**

```
MQ2                   STM32F407
  VCC ──红线(公对母)──→ 5V引脚   ⚠️注意是5V！
  GND ──黑线(公对母)──→ GND引脚
  AO  ──白线(公对公)──→ PA0引脚
  DO  ──不接
```

**功耗：150mA @ 5V （从STM32取电）**

---

#### **4.3 ATGM336H GPS模块**

```
GPS                   STM32F407
  VCC ──红线(公对母)──→ 3.3V引脚
  GND ──黑线(公对母)──→ GND引脚
  TX  ──橙线(公对公)──→ PA3引脚 ← GPS发送，STM32接收
  RX  ──棕线(公对公)──→ PA2引脚 ← GPS接收，STM32发送
  PPS ──不接
```

**⚠️ 注意：TX/RX交叉连接！**
**功耗：40mA @ 3.3V （从STM32取电）**

---

#### **4.4 ESP01S WiFi模块（⭐高功耗！）**

```
ESP01S (8个引脚)            电源模块 + STM32
引脚定义：
1-GND  2-GPIO2  3-GPIO0  4-RX
5-TX   6-EN     7-RST    8-VCC

供电连接（从电源模块取电）：
  8-VCC ──红线1─→ 电源模块蓝色端子孔位1或2 (3.3V)
  6-EN  ──红线2─→ 电源模块蓝色端子孔位1或2 (3.3V)
  7-RST ──红线3─→ 电源模块蓝色端子孔位1或2 (3.3V)
  1-GND ──黑线──→ 电源模块蓝色端子孔位3或6 (GND)

信号连接（连STM32，交叉）：
  5-TX  ──蓝线(公对公)─→ STM32 PB11引脚 (USART3_RX)
  4-RX  ──紫线(公对公)─→ STM32 PB10引脚 (USART3_TX)
  2-GPIO2 ──不接
  3-GPIO0 ──不接
```

**⚠️ 为什么从电源模块取电？**
- ESP01S峰值电流300mA，从STM32取电可能不稳定！
- 独立供电更可靠！

**功耗：80mA典型，300mA峰值 @ 3.3V （从电源模块取电）**

---

#### **4.5 ASR-PRO 语音模块（本次测试跳过）**

**暂时不连接！等后续完善代码后再测试。**

---

### **第5步：共地连接（⚠️最重要！）**

**必须用一根杜邦线连接：**

```
STM32开发板的GND引脚
    ↕ (一根黑色杜邦线)
电源模块蓝色端子的GND孔 (孔位3或6)

这根线叫"共地线"！没有这根线：
  ❌ UART通信会乱码
  ❌ 传感器数据异常
  ❌ ESP01S反复重启
```

**检查方法：**
```
用万用表蜂鸣档测量：
  STM32的GND引脚 ←→ 电源模块的GND孔
  应该"滴"一声(导通)
```

---

### **第6步：硬件连接完成检查**

#### **断电状态检查：**
```
□ 所有电源线(红线)没有接到GND
□ 所有GND线(黑线)没有接到VCC
□ 没有裸露的金属引脚相碰
□ 所有杜邦线插入牢固
□ 电源模块端子螺丝拧紧
□ 共地线已连接 ⚠️
```

#### **上电检查：**
```
1. 先给STM32上电(插USB)
2. 再给电源模块上电(打开红色开关)

观察：
□ 电源模块LED亮起 ✓
□ STM32开发板LED亮起 ✓
□ MQ2传感器LED1(电源)亮起 ✓
□ MQ2传感器微微发热(正常) ✓
□ GPS模块LED开始闪烁 ✓
□ ESP01S蓝色LED闪烁 ✓
□ 没有任何模块冒烟/异味 ✓
```

#### **万用表测量：**
```
□ STM32的3.3V引脚 = 3.3V (±0.1V) ✓
□ STM32的5V引脚 = 5.0V (±0.2V) ✓
□ 电源模块3.3V孔 = 3.3V (±0.1V) ✓
□ 电源模块5V孔 = 5.0V (±0.2V) ✓
□ MAX30102 VCC引脚 = 3.3V ✓
□ MQ2 VCC引脚 = 5.0V ✓
□ ESP01S VCC引脚 = 3.3V ✓
```

**如果以上检查都通过，硬件连接完成！** ✅

---

## 💻 **阶段2：Keil软件配置（15分钟）**

### **第1步：打开项目**

1. 启动Keil MDK-ARM (μVision5)
2. 打开项目文件：
   ```
   F:\RT\smart_helmet_f407\MDK-ARM\smart_helmet_f407.uvprojx
   ```

---

### **第2步：配置DAPLink调试器**

**详细步骤请参考：`docs/🛠️ DAPLink调试配置指南.md`**

**简化版配置：**

1. **选择调试器**：
   ```
   Project → Options for Target (Alt+F7)
   → Debug标签页
   → Use: CMSIS-DAP Debugger (或ST-Link Debugger)
   ```

2. **配置Debug Settings**（点击Settings按钮）：
   ```
   Debug标签页：
     - Port: SW (不是JTAG)
     - Max Clock: 10MHz

   Trace标签页（⭐关键！）：
     ☑ Trace Enable
     - Core Clock: 168 MHz
     - Trace Port: SWO
     ☑ ITM Stimulus Port 0 (必须勾选！)
   ```

3. **点击OK保存**

---

### **第3步：打开ITM输出窗口**

```
View → Serial Windows → Debug (printf) Viewer
```

这个窗口会显示所有printf输出！

---

### **第4步：编译项目**

```
快捷键：F7
或点击：Project → Build Target
```

**预期结果：**
```
Build target 'smart_helmet_f407'
compiling main.c...
compiling scheduler.c...
compiling max30102.c...
compiling mq2.c...
compiling atgm336h.c...
compiling esp01s.c...
compiling asr_pro.c...
...
linking...
creating hex file from images...
"smart_helmet_f407\smart_helmet_f407.axf" - 0 Error(s), 0 Warning(s).
Build Time Elapsed:  00:00:15
```

**如果有错误，先不要继续！** 把错误信息告诉我。

---

### **第5步：下载程序到STM32**

```
快捷键：F8
或点击：Flash → Download
```

**预期结果：**
```
Load "F:\\RT\\smart_helmet_f407\\MDK-ARM\\smart_helmet_f407\\smart_helmet_f407.axf"
Erase Done.
Programming Done.
Verify OK.
```

---

### **第6步：进入调试模式**

```
快捷键：Ctrl + F5
或点击：Debug → Start/Stop Debug Session
```

**预期结果：**
- Keil进入调试模式
- 代码编辑器高亮显示当前执行位置
- 底部出现调试控制按钮

---

### **第7步：运行程序**

```
快捷键：F5
或点击工具栏的：Run按钮（绿色三角形）
```

**程序开始运行！**

---

## 🎯 **阶段3：功能测试与预期输出（30分钟）**

### **第1步：查看系统启动信息**

在 **Debug (printf) Viewer** 窗口中，你应该看到：

```
========================================
STM32智能安全帽系统启动
========================================
MAX30102: Init Success
MQ2: Init Success, ADC=1234
GPS: Init Success
ESP01S: Init Success
ASR-PRO: Init Success
所有模块初始化完成！
========================================
```

**如果没有看到输出：**
- 检查Trace配置是否正确（Core Clock=168MHz, Port 0勾选）
- 按STM32复位键重新启动

---

### **第2步：逐个测试传感器**

#### **✅ 测试1：MAX30102 心率血氧传感器**

**测试方法：**
1. 手指轻轻放在MAX30102的传感器上
2. 保持手指不动，等待10-15秒

**预期输出：**
```
MAX30102: Reading...
MAX30102: HR=--bpm, SpO2=--%  (前几秒无效数据)
MAX30102: HR=75bpm, SpO2=98%  (稳定后显示)
MAX30102: HR=76bpm, SpO2=98%
MAX30102: HR=75bpm, SpO2=97%
```

**判断标准：**
- ✅ 心率在60-100之间
- ✅ 血氧在95-100之间
- ✅ 数值相对稳定（±5范围内波动）

**如果失败：**
- 检查SCL/SDA是否接对（PB14/PB15）
- 检查VCC是否3.3V
- 手指按压力度不要太重也不要太轻

---

#### **✅ 测试2：MQ2 烟雾传感器**

**测试方法：**
1. 正常环境下观察数值
2. 用打火机（不点燃）靠近传感器
3. 观察数值变化

**预期输出：**
```
MQ2: Gas=52ppm (正常环境)
MQ2: Gas=55ppm
MQ2: Gas=180ppm (打火机靠近)
MQ2: Gas=350ppm (更靠近)
⚠️ 危险！烟雾浓度过高！
MQ2: Gas=120ppm (拿开后恢复)
MQ2: Gas=58ppm
```

**判断标准：**
- ✅ 正常环境：50-150ppm
- ✅ 打火机靠近：数值上升到200+ppm
- ✅ 拿开后数值逐渐恢复

**⚠️ 注意：**
- MQ2传感器需要预热1-3分钟才准确
- 第一次上电数值可能偏高，等待稳定

**如果失败：**
- 检查VCC是否5V（不是3.3V！）
- 检查AO是否接PA0
- 检查MQ2的LED是否亮起

---

#### **✅ 测试3：ATGM336H GPS模块**

**测试方法：**
1. 将GPS模块放到窗边或户外
2. 天线朝上
3. 等待1-3分钟（冷启动需要时间）

**预期输出：**
```
GPS: Waiting for fix...
GPS: Satellites: 0
GPS: Waiting for fix...
GPS: Satellites: 3
GPS: Waiting for fix...
GPS: Satellites: 6
GPS: Location Fixed!
GPS: Lat=31.2304, Lon=121.4737, Sats=8
GPS: Lat=31.2304, Lon=121.4738, Sats=9
```

**判断标准：**
- ✅ 室内：可能一直显示"Waiting for fix"，卫星数0-2
- ✅ 窗边：1-3分钟后定位成功，卫星数4-8
- ✅ 户外：30秒-1分钟定位成功，卫星数8-12

**GPS LED指示：**
- 1秒1次闪烁 = 搜星中
- 快速闪烁或常亮 = 已定位

**如果失败：**
- 检查TX/RX是否交叉连接（GPS TX→PA3, GPS RX→PA2）
- 确认波特率9600（已在usart.c中配置）
- 将GPS移到窗边或户外

---

#### **✅ 测试4：ESP01S WiFi模块**

**测试方法：**
1. 确认已修改WiFi配置（esp01s.h）
2. 确认WiFi路由器已开启
3. 观察连接过程

**预期输出（成功情况）：**
```
ESP01S: Init Success
ESP01S: Connecting to WiFi [TP-LINK_8888]...
ESP01S: WiFi Connected! IP=192.168.1.100
ESP01S: Connecting to MQTT...
ESP01S: MQTT Connected!
ESP01S: Uploading data...
ESP01S: Data uploaded successfully
```

**预期输出（失败情况）：**
```
ESP01S: Init Success
ESP01S: Connecting to WiFi [TP-LINK_8888]...
ESP01S: WiFi connection failed, retrying...
ESP01S: WiFi connection failed, retrying...
```

**判断标准：**
- ✅ WiFi连接成功（显示IP地址）
- ⚠️ MQTT连接失败正常（如果没配置云平台）
- ✅ ESP01S蓝灯应该持续闪烁

**如果WiFi连接失败：**
1. **检查配置**：
   - WiFi名称是否正确（区分大小写）
   - WiFi密码是否正确
   - 是否重新编译并下载了程序

2. **检查供电**：
   - 用万用表测量ESP01S的VCC引脚 = 3.3V
   - 测量EN引脚 = 3.3V
   - 测量RST引脚 = 3.3V
   - 如果电压不稳，在VCC和GND之间焊一个100μF电容

3. **检查信号线**：
   - ESP01S TX → STM32 PB11（交叉）
   - ESP01S RX → STM32 PB10（交叉）

4. **简化测试**：
   - 先确认ESP01S单独能用AT指令响应
   - 用串口工具连ESP01S，发送"AT"，应该回复"OK"

---

#### **⚠️ 测试5：ASR-PRO 语音模块（跳过）**

**输出：**
```
ASR-PRO: Init Success
```

**这个模块暂时只输出初始化信息，不测试实际功能。**
**等稍后完善代码后再测试。**

---

### **第3步：综合测试（所有传感器同时运行）**

**让程序持续运行5分钟，观察输出：**

```
[00:00:05] MAX30102: HR=75bpm, SpO2=98%
[00:00:05] MQ2: Gas=52ppm
[00:00:05] GPS: Waiting for fix...
[00:00:05] ESP01S: WiFi Connected

[00:00:10] MAX30102: HR=76bpm, SpO2=98%
[00:00:10] MQ2: Gas=55ppm
[00:00:10] GPS: Satellites: 4
[00:00:10] ESP01S: Uploading data...

[00:00:15] MAX30102: HR=75bpm, SpO2=97%
[00:00:15] MQ2: Gas=53ppm
[00:00:15] GPS: Location Fixed! Lat=31.2304, Lon=121.4737
[00:00:15] ESP01S: Data uploaded

[00:00:20] ...
```

**判断标准：**
- ✅ 所有传感器数据正常更新
- ✅ 没有死机或重启
- ✅ 数据更新周期符合预期：
  - MAX30102: 每200ms
  - MQ2: 每500ms
  - GPS: 每1000ms
  - ESP01S: 每5000ms

---

## 📊 **测试结果记录表**

| 模块 | 状态 | 测试数据 | 备注 |
|------|------|---------|------|
| MAX30102 | ✅/❌ | HR=__bpm, SpO2=__% | |
| MQ2 | ✅/❌ | Gas=__ppm | |
| GPS | ✅/❌ | Lat=__, Lon=__, Sats=__ | |
| ESP01S | ✅/❌ | WiFi: ✅/❌, MQTT: ✅/❌ | |
| ASR-PRO | ⚠️跳过 | - | 稍后实现 |

---

## 🐛 **常见问题排查**

### **问题1：ITM窗口没有任何输出**

**症状：** Debug (printf) Viewer窗口空白

**排查步骤：**
1. 检查Keil配置：
   ```
   Options → Debug → Settings → Trace
   ☑ Trace Enable
   - Core Clock: 168 MHz
   - Trace Port: SWO
   ☑ ITM Port 0 勾选
   ```

2. 重新下载程序（F8）并重新启动调试（Ctrl+F5）

3. 按STM32复位键

4. 如果还是没有，检查DAPLink连接：
   - SWDIO → PA13
   - SWCLK → PA14
   - GND → GND

---

### **问题2：某个模块初始化失败**

**症状：** 输出显示"Init Failed"

**MAX30102初始化失败：**
```
原因：I2C通信失败
排查：
- 检查SCL/SDA接线（PB14/PB15）
- 检查VCC = 3.3V
- 检查GND连接
```

**MQ2初始化失败：**
```
原因：ADC读取失败
排查：
- 检查AO接线（PA0）
- 检查VCC = 5V（不是3.3V！）
```

**GPS初始化失败：**
```
原因：UART没有收到数据
排查：
- 检查TX/RX交叉连接（GPS TX→PA3, GPS RX→PA2）
- 检查VCC = 3.3V
```

**ESP01S初始化失败：**
```
原因：AT指令没有响应
排查：
- 检查TX/RX交叉连接（ESP TX→PB11, ESP RX→PB10）
- 检查VCC/EN/RST都接3.3V
- 检查供电是否稳定（可能需要加电容）
```

---

### **问题3：ESP01S反复重启**

**症状：** 蓝灯狂闪，串口输出不断重复初始化信息

**原因：** 供电不足（300mA峰值电流）

**解决方法：**
1. 确认从电源模块取电（不是STM32）
2. 用万用表测量ESP01S的VCC引脚电压
   - 应该稳定在3.3V
   - 如果电压波动 > 0.2V，说明供电不足

3. 解决供电不足：
   - 在ESP01S的VCC和GND之间并联100μF电容
   - 更换更大功率的DC适配器（2A）
   - 检查电源模块接线端子是否拧紧

---

### **问题4：程序运行一段时间后死机**

**症状：** 传感器数据停止更新，或程序卡住

**可能原因：**
1. **栈溢出** - 检查是否有大数组定义在栈上
2. **死循环** - 某个任务函数陷入死循环
3. **中断冲突** - UART中断处理时间过长

**排查方法：**
1. 使用Keil的单步调试（F10/F11）
2. 在while(1)循环中添加LED闪烁，确认主循环是否运行
3. 注释掉部分传感器任务，逐个排查

---

### **问题5：GPS一直显示"Waiting for fix"**

**原因：** 室内无法接收卫星信号

**解决方法：**
1. 将GPS移到窗边（尽量靠近窗户）
2. 天线朝上放置
3. 耐心等待3-5分钟（冷启动需要时间）
4. 如果有条件，移到户外测试

**GPS LED状态：**
- 1秒1次闪烁 = 搜星中（正常）
- 快速闪烁 = 已收到部分卫星信号
- 常亮 = 已定位成功

---

## ✅ **测试完成标准**

### **基本标准（必须达到）：**
```
□ 所有模块初始化成功（不包括ASR-PRO）
□ MAX30102能检测心率和血氧
□ MQ2能检测烟雾浓度变化
□ GPS能显示卫星数量（定位成功更佳）
□ ESP01S能连接WiFi（MQTT可选）
□ 程序持续运行5分钟无死机
```

### **高级标准（加分项）：**
```
□ GPS在窗边能定位成功
□ ESP01S能连接MQTT并上传数据
□ 所有传感器数据稳定可靠
□ 无任何警告或异常输出
```

---

## 🎉 **测试完成后续步骤**

### **如果测试全部通过：**
1. ✅ 恭喜！硬件和代码都没问题！
2. 📝 记录测试结果和传感器数据
3. 🎥 可以录制演示视频（用于面试）
4. 📚 准备面试问答（参考docs/03-面试问答宝典.md）

### **如果部分模块失败：**
1. 📋 记录失败的模块和错误信息
2. 🔍 按照上面的排查步骤逐一检查
3. 💬 把完整的错误输出告诉我，我帮你快速定位

### **下一步工作：**
1. ⚠️ 完善ASR-PRO语音模块（需要天问软件配置）
2. 🌐 配置MQTT云平台（可选）
3. 📱 开发手机APP或Web界面（可选）
4. 🎨 设计PCB和外壳（如果做成品）

---

## 📚 **相关文档**

- 📋 [硬件连接图](./🔌%20最简单实物连接图-混合供电.md)
- 🛠️ [DAPLink调试配置](./🛠️%20DAPLink调试配置指南.md)
- 🎓 [面试问答宝典](./03-面试问答宝典.md)
- 📖 [技术实现详解](./📖%20技术实现详解-面试必读.md)

---

**📅 文档创建**: 2025-12-03
**✍️ 作者**: Claude AI Assistant
**📧 问题反馈**: 测试过程中有任何问题，随时告诉我！

---

**🎊 祝测试顺利！有问题随时找我！** 🚀
